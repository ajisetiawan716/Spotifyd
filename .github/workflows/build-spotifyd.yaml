name: build-spotifyd-openwrt

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'package/**'
      - '.github/workflows/build-spotifyd.yaml'

jobs:
  build:
    name: build (${{ matrix.target }})
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64
            pretty: x86-64
            sdk: https://downloads.openwrt.org/releases/23.05.5/targets/x86/64/openwrt-sdk-23.05.5-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz
          - target: aarch64
            pretty: mediatek-filogic  
            sdk: https://downloads.openwrt.org/releases/23.05.5/targets/mediatek/filogic/openwrt-sdk-23.05.5-mediatek-filogic_gcc-12.3.0_musl.Linux-x86_64.tar.xz

    env:
      TERM: dumb  # Non-interactive terminal
      DEBIAN_FRONTEND: noninteractive
      KCONFIG_NONINTERACTIVE: 1  # Non-interactive kernel config

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install basic dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential git curl xz-utils python3

      - name: Download OpenWrt SDK
        run: |
          curl -fsSL "${{ matrix.sdk }}" -o sdk.tar.xz
          tar -xf sdk.tar.xz
          echo "SDK_DIR=$(echo openwrt-sdk-*)" >> $GITHUB_ENV

      - name: Setup feeds non-interactive
        working-directory: ${{ env.SDK_DIR }}
        run: |
          # Setup environment untuk non-interactive
          export TERM=dumb
          export DEBIAN_FRONTEND=noninteractive
          export KCONFIG_NONINTERACTIVE=1
          
          # Update feeds
          ./scripts/feeds update packages
          
          # Install dependencies
          ./scripts/feeds install rust alsa-lib libstdcpp libpthread
          
          # Add local feed
          echo "src-link local $GITHUB_WORKSPACE/package" >> feeds.conf.default
          ./scripts/feeds update local
          ./scripts/feeds install spotifyd-ng

      - name: Build with defconfig (non-interactive)
        working-directory: ${{ env.SDK_DIR }}
        run: |
          # Set environment untuk non-interactive
          export TERM=dumb
          export KCONFIG_NONINTERACTIVE=1
          
          # Gunakan defconfig untuk menghindari menuconfig
          make defconfig
          
          # Pastikan Rust terpilih
          echo "CONFIG_PACKAGE_RUST=y" >> .config
          echo "CONFIG_PACKAGE_spotifyd-ng=y" >> .config
          make defconfig
          
          # Build package
          make package/spotifyd-ng/compile V=s

      - name: Collect artifacts
        working-directory: ${{ env.SDK_DIR }}
        run: |
          mkdir -p "$GITHUB_WORKSPACE/out/${{ matrix.target }}"
          find bin -name "*spotifyd-ng*.ipk" -exec cp {} "$GITHUB_WORKSPACE/out/${{ matrix.target }}/" \;

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: spotifyd-${{ matrix.target }}-ipk
          path: out/${{ matrix.target }}/