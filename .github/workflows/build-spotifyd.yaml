name: build-spotifyd-openwrt-standalone

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - '.github/workflows/build-spotifyd.yaml'

jobs:
  build:
    name: build (${{ matrix.target }})
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64
            arch: x86_64
            toolchain: https://downloads.openwrt.org/releases/23.05.5/targets/x86/64/openwrt-sdk-23.05.5-x86_64_gcc-12.3.0_musl.Linux-x86_64.tar.xz
          - target: aarch64
            arch: aarch64
            toolchain: https://downloads.openwrt.org/releases/23.05.5/targets/mediatek/filogic/openwrt-sdk-23.05.5-mediatek-filogic_gcc-12.3.0_musl.Linux-x86_64.tar.xz

    steps:
      - name: Checkout spotifyd source
        uses: actions/checkout@v4
        with:
          repository: Spotifyd/spotifyd
          ref: v0.4.1
          path: spotifyd-src

      - name: Apply librespot patch
        run: |
          set -eux
          cd spotifyd-src
          
          # Apply librespot patch
          sed -i '/^\[patch.crates-io\]/,/^$/d' Cargo.toml
          echo '[patch.crates-io]' >> Cargo.toml
          echo 'librespot = { git = "https://github.com/librespot-org/librespot.git", rev = "be37402" }' >> Cargo.toml
          
          echo "âœ… Librespot patch applied"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential git curl wget \
            xz-utils tar python3 python3-distutils \
            libncurses-dev unzip rsync gawk gettext \
            musl-tools pkg-config libssl-dev

      - name: Install Rust toolchain
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          source $HOME/.cargo/env
          rustc --version
          cargo --version

      - name: Download OpenWRT toolchain only
        run: |
          set -eux
          echo "Downloading toolchain for ${{ matrix.target }}..."
          curl -fsSL "${{ matrix.toolchain }}" -o toolchain.tar.xz
          mkdir -p /opt/openwrt-toolchain
          tar -xf toolchain.tar.xz --strip-components=1 -C /opt/openwrt-toolchain \
            --wildcards '*/staging_dir/toolchain-*'
          
          export TOOLCHAIN_DIR="/opt/openwrt-toolchain"
          echo "TOOLCHAIN_DIR=$TOOLCHAIN_DIR" >> $GITHUB_ENV

      - name: Setup cross-compilation environment
        run: |
          set -eux
          
          if [ "${{ matrix.target }}" = "x86_64" ]; then
            export CC="$TOOLCHAIN_DIR/toolchain-x86_64_gcc-12.3.0_musl/bin/x86_64-openwrt-linux-gcc"
            export AR="$TOOLCHAIN_DIR/toolchain-x86_64_gcc-12.3.0_musl/bin/x86_64-openwrt-linux-ar"
            export STRIP="$TOOLCHAIN_DIR/toolchain-x86_64_gcc-12.3.0_musl/bin/x86_64-openwrt-linux-strip"
            export CARGO_TARGET=x86_64-unknown-linux-musl
          else
            export CC="$TOOLCHAIN_DIR/toolchain-aarch64_cortex-a53_gcc-12.3.0_musl/bin/aarch64-openwrt-linux-gcc"
            export AR="$TOOLCHAIN_DIR/toolchain-aarch64_cortex-a53_gcc-12.3.0_musl/bin/aarch64-openwrt-linux-ar"
            export STRIP="$TOOLCHAIN_DIR/toolchain-aarch64_cortex-a53_gcc-12.3.0_musl/bin/aarch64-openwrt-linux-strip"
            export CARGO_TARGET=aarch64-unknown-linux-musl
          fi
          
          rustup target add $CARGO_TARGET
          
          echo "CC=$CC" >> $GITHUB_ENV
          echo "AR=$AR" >> $GITHUB_ENV
          echo "STRIP=$STRIP" >> $GITHUB_ENV
          echo "CARGO_TARGET=$CARGO_TARGET" >> $GITHUB_ENV

      - name: Build spotifyd standalone
        run: |
          set -eux
          cd spotifyd-src
          
          # Build dengan cross-compilation
          CARGO_HOME="$HOME/.cargo" \
          RUSTFLAGS="-C linker=$CC -C ar=$AR -C target-feature=+crt-static" \
          cargo build \
            --release \
            --no-default-features \
            --features alsa_backend \
            --target $CARGO_TARGET
          
          # Strip binary untuk mengurangi size
          $STRIP target/$CARGO_TARGET/release/spotifyd

      - name: Create OpenWRT package
        run: |
          set -eux
          mkdir -p spotifyd-ng_control
          
          # Create control file tanpa heredocs
          echo "Package: spotifyd-ng" > spotifyd-ng_control/control
          echo "Version: 0.4.1-1" >> spotifyd-ng_control/control
          echo "Depends: libc, alsa-lib, libstdcpp, libpthread" >> spotifyd-ng_control/control
          echo "Source: https://github.com/Spotifyd/spotifyd" >> spotifyd-ng_control/control
          echo "Section: sound" >> spotifyd-ng_control/control
          echo "Category: Sound" >> spotifyd-ng_control/control
          echo "Title: Spotify daemon" >> spotifyd-ng_control/control
          echo "Maintainer: Build Bot <noreply@github.com>" >> spotifyd-ng_control/control
          echo "Architecture: ${{ matrix.arch }}" >> spotifyd-ng_control/control
          echo "Description: A spotify playing daemon for OpenWrt." >> spotifyd-ng_control/control
          
          # Create package structure
          mkdir -p spotifyd-ng_{data,ipk}
          mkdir -p spotifyd-ng_data/usr/bin
          
          # Copy binary
          cp spotifyd-src/target/$CARGO_TARGET/release/spotifyd spotifyd-ng_data/usr/bin/
          chmod +x spotifyd-ng_data/usr/bin/spotifyd
          
          # Create IPK package
          cd spotifyd-ng_data && tar -czf ../data.tar.gz . && cd ..
          cd spotifyd-ng_control && tar -czf ../control.tar.gz . && cd ..
          echo "2.0" > debian-binary
          
          # Create final IPK
          tar -czf spotifyd-ng_${{ matrix.arch }}.ipk ./debian-binary ./data.tar.gz ./control.tar.gz
          
          # Create output directory
          mkdir -p output/${{ matrix.target }}
          mv spotifyd-ng_${{ matrix.arch }}.ipk output/${{ matrix.target }}/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: spotifyd-${{ matrix.target }}-ipk
          path: output/${{ matrix.target }}/
          if-no-files-found: error

      - name: Verify package
        run: |
          echo "=== PACKAGE VERIFICATION ==="
          echo "Binary info:"
          file spotifyd-src/target/$CARGO_TARGET/release/spotifyd
          echo "Package contents:"
          tar -ztvf output/${{ matrix.target }}/*.ipk